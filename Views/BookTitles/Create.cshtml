@model ObreshkovLibrary.Models.ViewModels.BookCreateVM

@{
    ViewData["Title"] = "Добави книга";
}

<div style="padding-top:6px;max-width:920px;">

    <h1 style="color:#0F766E;font-weight:900;margin-bottom:14px;">Добави книга</h1>

    <form id="bookCreateForm" asp-action="Create" method="post"
          style="background:#fff;border-radius:18px;padding:16px;box-shadow:0 10px 25px rgba(0,0,0,.08);border:1px solid rgba(0,0,0,.06);">

        @Html.AntiForgeryToken()
        <div asp-validation-summary="All" class="text-danger" style="font-weight:800;"></div>

        <div class="mb-3">
            <label asp-for="Title" style="font-weight:900;color:#0F766E;">Заглавие</label>
            <input asp-for="Title" class="form-control" />
            <span asp-validation-for="Title" class="text-danger"></span>
        </div>

        <div class="mb-3">
            <label asp-for="Author" style="font-weight:900;color:#0F766E;">Автор</label>
            <input asp-for="Author" class="form-control" />
            <span asp-validation-for="Author" class="text-danger"></span>
        </div>

        <div class="mb-3">
            <label asp-for="Year" style="font-weight:900;color:#0F766E;">Година</label>
            <input asp-for="Year" type="number" class="form-control" />
            <span asp-validation-for="Year" class="text-danger"></span>
        </div>

        <div class="mb-3">
            <label asp-for="Description" style="font-weight:900;color:#0F766E;">Описание</label>
            <textarea asp-for="Description" rows="4" class="form-control"></textarea>
            <span asp-validation-for="Description" class="text-danger"></span>
        </div>

        <div class="mb-3">
            <label asp-for="CoverUrl" style="font-weight:900;color:#0F766E;">Линк към корица (URL)</label>
            <input asp-for="CoverUrl" class="form-control" placeholder="https://..." />
            <span asp-validation-for="CoverUrl" class="text-danger"></span>
        </div>

        <hr />

        <div class="mb-3">
            <label style="font-weight:900;color:#0F766E;">Главна категория</label>
            <select asp-for="Level1Id" id="level1" class="form-select">
                <option value="">-- избери --</option>
                @foreach (var c in Model.Level1Options)
                {
                    <option value="@c.Id">@c.Name</option>
                }
            </select>
            <span asp-validation-for="Level1Id" class="text-danger"></span>
        </div>

        <div class="mb-3">
            <label style="font-weight:900;color:#0F766E;">Подкатегория</label>
            <select asp-for="Level2Id" id="level2" class="form-select" disabled>
                <option value="">-- избери --</option>
            </select>
            <span asp-validation-for="Level2Id" class="text-danger"></span>
        </div>

        <div class="mb-3">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
                <div style="font-weight:900;color:#0F766E;">Етикети</div>

                <button type="button"
                        class="btn"
                        data-bs-toggle="modal"
                        data-bs-target="#tagsModal"
                        style="background:#FB923C;color:#fff;font-weight:900;border-radius:12px;border:none;padding:10px 14px;box-shadow:0 8px 18px rgba(0,0,0,.10);">
                    + Добави
                </button>
            </div>

            <div id="tagsPreview" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;"></div>
            <input asp-for="TagsText" type="hidden" id="TagsText" />
        </div>

        <div class="mt-3" style="display:flex;gap:10px;flex-wrap:wrap;">
            <button type="submit"
                    class="btn"
                    style="background:#0F766E;color:#fff;font-weight:900;border-radius:12px;border:none;padding:10px 14px;box-shadow:0 8px 18px rgba(0,0,0,.10);">
                Запази
            </button>

            <a asp-action="Index"
               class="btn"
               style="background:#FFF3C4;color:#0F766E;font-weight:900;border-radius:12px;border:1px solid rgba(0,0,0,.10);padding:10px 14px;">
                Назад
            </a>
        </div>
    </form>
</div>

<div class="modal fade" id="tagsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius:16px;overflow:hidden;">
            <div class="modal-header" style="background:#E6FFFA;">
                <h5 class="modal-title" style="margin:0;font-weight:900;color:#0F766E;">Етикети</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Затвори"></button>
            </div>

            <div class="modal-body">
                <div style="border:1px solid rgba(0,0,0,.08);border-radius:14px;overflow:hidden;">
                    <div style="display:grid;grid-template-columns:60px 1fr;gap:0;background:#F8FAFC;border-bottom:1px solid rgba(0,0,0,.06);">
                        <div style="padding:10px 12px;font-weight:900;color:#0F766E;">#</div>
                        <div style="padding:10px 12px;font-weight:900;color:#0F766E;">Етикет</div>
                    </div>

                    <div id="tagsRows">
                        @for (int i = 1; i <= 12; i++)
                        {
                            <div style="display:grid;grid-template-columns:60px 1fr;gap:0;border-bottom:1px solid rgba(0,0,0,.06);">
                                <div style="padding:10px 12px;display:flex;align-items:center;justify-content:center;font-weight:950;color:#0F766E;background:#fff;">
                                    @i
                                </div>
                                <div style="padding:8px 10px;background:#fff;">
                                    <input class="form-control tag-row"
                                           data-idx="@i"
                                           style="border-radius:12px;" />
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;">
                    <button type="button"
                            id="btnClearTags"
                            class="btn"
                            style="background:#FFF3C4;color:#0F766E;font-weight:900;border-radius:12px;border:1px solid rgba(0,0,0,.10);padding:10px 14px;">
                        Изчисти
                    </button>

                    <button type="button"
                            id="btnApplyTags"
                            class="btn"
                            style="background:#FB923C;color:#fff;font-weight:900;border-radius:12px;border:none;padding:10px 14px;box-shadow:0 8px 18px rgba(0,0,0,.10);">
                        Приложи
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        async function loadChildren(parentId) {
            const res = await fetch(`/Categories/GetChildren?parentId=${parentId}`);
            return await res.json();
        }

        const level1 = document.getElementById('level1');
        const level2 = document.getElementById('level2');

        level1.addEventListener('change', async () => {
            level2.innerHTML = '<option value="">-- избери --</option>';
            level2.disabled = true;

            if (!level1.value) return;

            const children = await loadChildren(level1.value);
            children.forEach(x => {
                level2.innerHTML += `<option value="${x.id}">${x.name}</option>`;
            });
            level2.disabled = children.length === 0;
        });
    </script>

    <script>
        (function () {
            const tagsTextHidden = document.getElementById('TagsText');
            const preview = document.getElementById('tagsPreview');

            const rows = Array.from(document.querySelectorAll('.tag-row'));
            const btnApply = document.getElementById('btnApplyTags');
            const btnClear = document.getElementById('btnClearTags');

            function normalizeTag(s) {
                s = (s || '').trim();
                if (!s) return '';
                while (s.startsWith('#')) s = s.slice(1).trim();
                if (s.length > 30) s = s.slice(0, 30).trim();
                return s;
            }

            function renderPreview(tags) {
                preview.innerHTML = '';
                tags.forEach(t => {
                    const pill = document.createElement('span');
                    pill.style.cssText = "display:inline-flex;align-items:center;gap:8px;background:#E6FFFA;color:#0F766E;padding:6px 10px;border-radius:999px;font-weight:900;border:1px solid rgba(0,0,0,.08);";
                    pill.textContent = "#" + t;
                    preview.appendChild(pill);
                });
            }

            function setFromHiddenToRows() {
                const raw = tagsTextHidden.value || '';
                const tags = raw
                    .split(',')
                    .map(x => normalizeTag(x))
                    .filter(x => x.length > 0);

                rows.forEach(r => r.value = '');
                tags.slice(0, 12).forEach((t, i) => rows[i].value = t);

                renderPreview(tags);
            }

            btnClear.addEventListener('click', () => {
                rows.forEach(r => r.value = '');
                tagsTextHidden.value = '';
                renderPreview([]);
            });

            btnApply.addEventListener('click', () => {
                const tags = rows
                    .map(r => normalizeTag(r.value))
                    .filter(x => x.length > 0);

                const uniq = [];
                const seen = new Set();
                for (const t of tags) {
                    const key = t.toLowerCase();
                    if (seen.has(key)) continue;
                    seen.add(key);
                    uniq.push(t);
                }

                tagsTextHidden.value = uniq.join(', ');
                renderPreview(uniq);

                const modalEl = document.getElementById('tagsModal');
                bootstrap.Modal.getInstance(modalEl).hide();
            });

            document.getElementById('tagsModal').addEventListener('shown.bs.modal', () => {
                setFromHiddenToRows();
                const firstEmpty = rows.find(r => !r.value);
                (firstEmpty || rows[0]).focus();
            });

        })();
    </script>
}