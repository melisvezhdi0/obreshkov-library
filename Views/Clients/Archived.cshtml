@model IEnumerable<ObreshkovLibrary.Models.Client>

@{
    ViewData["Title"] = "Архив читатели";

    string searchValue = (ViewBag.Search ?? "").ToString();
    string classValue = (ViewBag.ClassFilter ?? "").ToString();
    bool hasFilters = !string.IsNullOrWhiteSpace(searchValue) || !string.IsNullOrWhiteSpace(classValue);

    var classes = Model
        .Select(c => $"{c.Grade}{c.Section}".Replace(" ", "").ToUpper())
        .Where(x => !string.IsNullOrWhiteSpace(x))
        .Distinct()
        .OrderBy(x => x.Length)
        .ThenBy(x => x)
        .ToList();

    bool noResults = (Model == null || !Model.Any()) && hasFilters;
}

<div style="padding-top:6px;">

    <div style="display:flex;align-items:flex-end;justify-content:space-between;gap:16px;flex-wrap:wrap;">
        <div>
            <h1 style="color:#0F766E;font-weight:900;margin-bottom:6px;">Архив — читатели</h1>

            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
                <a asp-action="Index"
                   style="background:#0F766E;color:#fff;padding:10px 16px;border-radius:10px;font-weight:800;text-decoration:none;display:inline-block;box-shadow:0 8px 18px rgba(0,0,0,.10);">
                    Към активни
                </a>
            </div>

            @if (hasFilters)
            {
                <div style="margin-top:10px;">
                    <span style="display:inline-flex;gap:8px;align-items:center;background:#E6FFFA;color:#0F766E;padding:8px 12px;border-radius:999px;font-weight:900;border:1px solid rgba(0,0,0,.08);">
                        Активни филтри:
                        @if (!string.IsNullOrWhiteSpace(classValue))
                        {
                            <span style="background:#FFF3C4;padding:3px 8px;border-radius:999px;border:1px solid rgba(0,0,0,.08);">Клас: @classValue</span>
                        }
                        @if (!string.IsNullOrWhiteSpace(searchValue))
                        {
                            <span style="background:#FFF3C4;padding:3px 8px;border-radius:999px;border:1px solid rgba(0,0,0,.08);">Търси: @searchValue</span>
                        }

                        <a asp-action="Archived"
                           style="margin-left:6px;background:#FB923C;color:#fff;padding:4px 10px;border-radius:999px;text-decoration:none;font-weight:900;">
                            Изчисти
                        </a>
                    </span>
                </div>
            }
        </div>

        <form id="clientsArchiveFilterForm" method="get" asp-action="Archived"
              style="min-width:320px;max-width:720px;width:100%;">

            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;">

                <!-- Клас dropdown  -->
                <div class="dropdown" id="classDropdownWrap" style="position:relative;">

                    <input id="classFilter"
                           name="classFilter"
                           value="@classValue"
                           placeholder="Клас"
                           autocomplete="off"
                           style="width:140px;padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,.12);outline:none;background:white;font-weight:900;color:#0F766E;box-shadow:0 6px 14px rgba(0,0,0,.06);" />

                    <div id="classMenu"
                         style="position:absolute;top:46px;left:0;width:140px;background:white;border-radius:12px;border:1px solid rgba(0,0,0,.10);box-shadow:0 14px 30px rgba(0,0,0,.12);padding:6px;display:none;max-height:260px;overflow:auto;z-index:9999;">

                        @if (classes.Count == 0)
                        {
                            <div style="padding:9px 10px;color:#64748B;font-weight:800;">Няма класове</div>
                        }
                        else
                        {
                            @foreach (var cls in classes)
                            {
                                <button type="button"
                                        class="class-item"
                                        data-value="@cls"
                                        style="width:100%;text-align:left;background:transparent;border:none;padding:9px 10px;border-radius:10px;font-weight:900;color:#0F766E;"
                                        onmouseover="this.style.background='#E6FFFA';"
                                        onmouseout="this.style.background='transparent';">
                                    @cls
                                </button>
                            }
                        }
                    </div>
                </div>

                <!-- Търсене -->
                <input id="searchBox"
                       name="search"
                       value="@searchValue"
                       placeholder="Търси име, телефон или № карта…"
                       style="flex:1;min-width:260px;padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,.12);outline:none;box-shadow:0 6px 14px rgba(0,0,0,.06);" />

                <button type="submit"
                        style="background:#FB923C;color:white;border:none;padding:10px 14px;border-radius:12px;font-weight:900;box-shadow:0 8px 18px rgba(0,0,0,.10);white-space:nowrap;">
                    Търси
                </button>

                <a asp-action="Archived"
                   style="background:#FFF3C4;color:#0F766E;border:1px solid rgba(0,0,0,.10);padding:10px 12px;border-radius:12px;font-weight:900;text-decoration:none;white-space:nowrap;">
                    Изчисти
                </a>
            </div>
        </form>
    </div>

    @if (noResults)
    {
        <div style="margin-top:18px;background:#fff;border-radius:18px;padding:16px;border:1px solid rgba(0,0,0,.06);box-shadow:0 10px 25px rgba(0,0,0,.08);">
            <div style="font-weight:900;color:#0F766E;">Няма резултати в архива по тези филтри.</div>
        </div>
    }

    <div style="margin-top:16px;background:#fff;border-radius:18px;padding:14px;
                box-shadow:0 10px 25px rgba(0,0,0,.08);border:1px solid rgba(0,0,0,.06);">

        @if (Model == null || !Model.Any())
        {
            <div style="color:#64748B;font-weight:800;">Архивът е празен.</div>
        }
        else
        {
            <div style="overflow:auto;">
                <table style="width:100%;border-collapse:separate;border-spacing:0 10px;">
                    <thead>
                        <tr style="color:#0F766E;font-weight:900;text-align:left;">
                            <th style="padding:6px 10px;">Име</th>
                            <th style="padding:6px 10px;">Клас</th>
                            <th style="padding:6px 10px;">Телефон</th>
                            <th style="padding:6px 10px;">№ карта</th>
                            <th style="padding:6px 10px;text-align:right;">Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var c in Model)
                        {
                            <tr style="background:#F8FAFC;border:1px solid rgba(0,0,0,.06);">
                                <td style="padding:10px 10px;border-top-left-radius:12px;border-bottom-left-radius:12px;font-weight:900;color:#0F766E;">
                                    @c.FirstName @c.MiddleName @c.LastName
                                </td>
                                <td style="padding:10px 10px;font-weight:900;color:#0F766E;">@c.Grade@c.Section</td>
                                <td style="padding:10px 10px;">@c.PhoneNumber</td>
                                <td style="padding:10px 10px;">@c.CardNumber</td>
                                <td style="padding:10px 10px;border-top-right-radius:12px;border-bottom-right-radius:12px;text-align:right;white-space:nowrap;">
                                    <a asp-action="Details" asp-route-id="@c.Id"
                                       style="background:#0F766E;color:#fff;padding:8px 12px;border-radius:10px;font-weight:900;text-decoration:none;display:inline-block;">
                                        Детайли
                                    </a>

                                    <form asp-action="Reactivate" asp-route-id="@c.Id" method="post" data-gate="1" style="display:inline;margin-left:8px;">
                                        @Html.AntiForgeryToken()
                                        <button type="submit"
                                                style="background:#FB923C;color:#fff;border:none;padding:8px 12px;border-radius:10px;font-weight:900;">
                                            Възстанови
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const input = document.getElementById('classFilter');
            const menu = document.getElementById('classMenu');
            const wrap = document.getElementById('classDropdownWrap');
            if (!input || !menu || !wrap) return;

            function openMenu() { menu.style.display = 'block'; }
            function closeMenu() { menu.style.display = 'none'; }

            input.addEventListener('focus', openMenu);
            input.addEventListener('click', openMenu);

            document.addEventListener('click', function (e) {
                if (!wrap.contains(e.target)) closeMenu();
            });

            menu.querySelectorAll('.class-item').forEach(btn => {
                btn.addEventListener('click', () => {
                    input.value = btn.getAttribute('data-value') || '';
                    closeMenu();
                });
            });
        })();
    </script>
}
