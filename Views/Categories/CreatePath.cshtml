@model ObreshkovLibrary.Models.ViewModels.CategoryPathVM

@{
    ViewData["Title"] = "Създай категории";
}

<h1 class="page-title">Създай категория</h1>
<div class="page-accent"></div>

<form id="createPathForm" asp-action="CreatePath" method="post" 
      style="background:#fff;border-radius:16px;padding:16px;box-shadow:0 10px 25px rgba(0,0,0,.08);border:1px solid rgba(0,0,0,.06);max-width:720px;">

    @Html.AntiForgeryToken()
    <div asp-validation-summary="ModelOnly" class="text-danger" style="font-weight:800;"></div>

    <!-- Основна категория -->
    <div class="mb-3">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <select id="level1Select" class="form-control" style="max-width:420px;">
                <option value="">Категория…</option>
            </select>

            <button type="button"
                    class="btn"
                    data-bs-toggle="modal"
                    data-bs-target="#addRootModal"
                    style="background:#FB923C;color:#fff;font-weight:900;border-radius:12px;border:none;padding:10px 14px;box-shadow:0 8px 18px rgba(0,0,0,.10);">
                + Добави
            </button>
        </div>

        <input type="hidden" asp-for="Level1" id="Level1" />
        <span asp-validation-for="Level1" class="text-danger"></span>
    </div>

    <!-- Подкатегория -->
    <div class="mb-3">
        <input id="level2Input"
               asp-for="Level2"
               class="form-control"
               placeholder="Подкатегория…"
               style="max-width:420px;" />

        <span asp-validation-for="Level2" class="text-danger"></span>
    </div>

    <div class="mt-3" style="display:flex;gap:10px;flex-wrap:wrap;">
        <button type="submit"
                class="btn"
                style="background:#0F766E;color:#fff;font-weight:900;border-radius:12px;border:none;padding:10px 14px;box-shadow:0 8px 18px rgba(0,0,0,.10);">
            Запази
        </button>

        <a asp-action="Index"
           class="btn"
           style="background:#FFF3C4;color:#0F766E;font-weight:900;border-radius:12px;border:1px solid rgba(0,0,0,.10);padding:10px 14px;">
            Назад
        </a>
    </div>
</form>

<!-- MODAL: добави основна категория -->
<div class="modal fade" id="addRootModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius:16px;overflow:hidden;">
            <div class="modal-header" style="background:#E6FFFA;">
                <h5 class="modal-title" style="margin:0;font-weight:900;color:#0F766E;">Добави категория</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Затвори"></button>
            </div>
            <div class="modal-body">
                <input id="newRootName" class="form-control" placeholder="Име…" />
                <div id="rootErr" class="text-danger" style="margin-top:8px;display:none;font-weight:800;"></div>
            </div>
            <div class="modal-footer" style="background:#F8FAFC;">
                <button type="button"
                        class="btn"
                        data-bs-dismiss="modal"
                        style="background:#FFF3C4;color:#0F766E;font-weight:900;border-radius:12px;border:1px solid rgba(0,0,0,.10);padding:10px 14px;">
                    Отказ
                </button>
                <button type="button"
                        id="btnSaveRoot"
                        class="btn"
                        style="background:#FB923C;color:#fff;font-weight:900;border-radius:12px;border:none;padding:10px 14px;box-shadow:0 8px 18px rgba(0,0,0,.10);">
                    Добави
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        (function () {
            const urlRoots = '@Url.Action("GetRoots", "Categories")';
            const urlQuickCreate = '@Url.Action("QuickCreate", "Categories")';
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            const level1Select = document.getElementById('level1Select');
            const hLevel1 = document.getElementById('Level1');

            const newRootName = document.getElementById('newRootName');
            const rootErr = document.getElementById('rootErr');
            const btnSaveRoot = document.getElementById('btnSaveRoot');

            async function loadRoots(selectedIdToPick) {
                const res = await fetch(urlRoots);
                const data = await res.json();

                level1Select.innerHTML = '<option value="">Категория…</option>';
                data.forEach(x => {
                    const opt = document.createElement('option');
                    opt.value = x.name;
                    opt.textContent = x.name;
                    opt.dataset.id = x.id;
                    level1Select.appendChild(opt);
                });

                if (selectedIdToPick) {
                    const optToSelect = Array.from(level1Select.options).find(o => o.dataset?.id === String(selectedIdToPick));
                    if (optToSelect) level1Select.value = optToSelect.value;
                    hLevel1.value = level1Select.value || '';
                }
            }

            loadRoots();

            level1Select.addEventListener('change', () => {
                hLevel1.value = level1Select.value || '';
            });

            function showErr(el, msg) { el.textContent = msg; el.style.display = 'block'; }
            function clearErr(el) { el.textContent = ''; el.style.display = 'none'; }

            btnSaveRoot.addEventListener('click', async () => {
                clearErr(rootErr);
                const nm = (newRootName.value || '').trim();
                if (!nm) { showErr(rootErr, 'Въведи име.'); return; }

                const data = new URLSearchParams();
                data.append('name', nm);

                const res = await fetch(urlQuickCreate, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                        'RequestVerificationToken': token
                    },
                    body: data.toString()
                });

                if (!res.ok) {
                    const txt = await res.text();
                    showErr(rootErr, txt || 'Грешка.');
                    return;
                }

                const json = await res.json();
                await loadRoots(json.id);

                const modalEl = document.getElementById('addRootModal');
                bootstrap.Modal.getInstance(modalEl).hide();
            });

            document.getElementById('addRootModal').addEventListener('shown.bs.modal', () => {
                clearErr(rootErr);
                newRootName.value = '';
                newRootName.focus();
            });

        })();
    </script>
}
